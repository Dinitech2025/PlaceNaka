generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  password  String?
  role      UserRole @default(CLIENT)
  phone     String?
  avatar    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organizedEvents Event[]       @relation("Organizer")
  venues          Venue[]       @relation("OrganizerVenues")
  reservations    Reservation[]

  @@index([email])
  @@index([role])
}

enum UserRole {
  CLIENT
  ORGANIZER
  ADMIN
}

model Venue {
  id          String   @id @default(cuid())
  name        String
  address     String
  city        String
  country     String   @default("FR")
  description String?
  images      String[]
  capacity    Int      @default(0)
  layout      Json?
  organizerId String
  organizer   User     @relation("OrganizerVenues", fields: [organizerId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  events Event[]

  @@index([organizerId])
  @@index([city])
}

model Event {
  id          String      @id @default(cuid())
  title       String
  description String?
  coverImage  String?
  startDate   DateTime
  endDate     DateTime
  status      EventStatus @default(DRAFT)
  venueId     String
  venue       Venue       @relation(fields: [venueId], references: [id], onDelete: Cascade)
  organizerId String
  organizer   User        @relation("Organizer", fields: [organizerId], references: [id], onDelete: Cascade)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  tickets      Ticket[]
  reservations Reservation[]

  @@index([organizerId])
  @@index([venueId])
  @@index([status])
  @@index([startDate])
}

enum EventStatus {
  DRAFT
  PUBLISHED
  ONGOING
  COMPLETED
  CANCELLED
}

// Catégorie de billet (ex: VIP, Standard, Carré Or)
model Ticket {
  id        String   @id @default(cuid())
  eventId   String
  event     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  name      String
  price     Int      @default(0) // en centimes
  quantity  Int      @default(0)
  available Int      @default(0)
  posX      Float?
  posY      Float?
  color     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  reservations Reservation[]

  @@index([eventId])
}

model Reservation {
  id         String            @id @default(cuid())
  userId     String
  user       User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  ticketId   String
  ticket     Ticket            @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  eventId    String
  event      Event             @relation(fields: [eventId], references: [id], onDelete: Cascade)
  quantity   Int               @default(1)
  totalPrice Int               @default(0) // en centimes
  status     ReservationStatus @default(PENDING)
  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt

  payment Payment?

  @@index([userId])
  @@index([ticketId])
  @@index([eventId])
  @@index([status])
}

enum ReservationStatus {
  PENDING
  CONFIRMED
  CANCELLED
  EXPIRED
}

model Payment {
  id              String        @id @default(cuid())
  reservationId   String        @unique
  reservation     Reservation   @relation(fields: [reservationId], references: [id], onDelete: Cascade)
  amount          Int           @default(0) // en centimes
  commission      Int           @default(0)
  organizerAmount Int           @default(0)
  currency        String        @default("EUR")
  status          PaymentStatus @default(PENDING)
  stripePaymentId String?
  paidAt          DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([status])
  @@index([paidAt])
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}
